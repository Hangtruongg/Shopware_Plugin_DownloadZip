(()=>{"use strict";let{PluginBaseClass:e}=window;window.PluginManager.register("HomsymCustomDownload",class extends e{init(){console.log("HomsymCustomDownload initialized"),this._registerEvents()}_registerEvents(){let e=document.querySelectorAll(".download-zip-btn"),o=document.getElementById("downloadPopup"),t=document.getElementById("confirmDownload"),n=document.getElementById("cancelDownload");if(document.getElementById("loadingPopup"),document.getElementById("loadingText"),!e||!o||!t||!n){console.warn("HomsymCustomDownloadPlugin: Required elements not found!");return}console.log("Elements found, adding event listeners..."),e.forEach(e=>{e.addEventListener("click",o=>{o.preventDefault(),console.log("Download button clicked!");let t=e.closest(".download-zip-container"),n=t.querySelector("#downloadPopup"),l=t.querySelector("#confirmDownload"),d=t.querySelector("#cancelDownload"),a=t.querySelector("#loadingPopup"),i=t.querySelector("#loadingText");l.dataset.downloadId=e.getAttribute("data-download-id"),l.dataset.orderId=e.getAttribute("data-order-id"),n.style.display="flex",d.addEventListener("click",()=>{console.log("Cancel button clicked! Closing popup."),n.style.display="none"}),l.dataset.listenerAttached||(l.addEventListener("click",async function(){let e=l.dataset.downloadId,o=l.dataset.orderId;console.log("Confirm button clicked! Showing loading popup..."),n.style.display="none",a.style.display="flex",i.innerText="Preparing download...";try{let t=window.location.pathname.split("/").slice(0,3).join("/"),n=window.location.pathname.startsWith("/account")?"":t,l="".concat(window.location.origin).concat(n,"/account/order/download/zip/").concat(o,"/").concat(e);console.log("Downloading from: ",l);let d=await fetch(l,{method:"GET",credentials:"include"});if(!d.ok)throw Error("Could not fetch resource");let c=d.headers.get("Content-Type");if(!c||!c.includes("application/zip"))throw Error("Invalid file type received. Expected ZIP.");let r=d.headers.get("Content-Disposition"),s="order-".concat(o,"-download.zip");if(r){let e=r.match(/filename="(.+)"/);e&&e[1]&&(s=e[1])}let u=d.headers.get("Content-Length"),w=0,p=d.body.getReader(),g=[];for(;;){let{done:e,value:o}=await p.read();if(e)break;g.push(o),w+=o.length,i.innerText=u?"Downloading... ".concat(Math.round(w/u*100),"%"):"Downloading..."}let m=new Blob(g),y=window.URL.createObjectURL(m),f=document.createElement("a");f.href=y,f.download=s,document.body.appendChild(f),f.click(),f.remove(),window.URL.revokeObjectURL(y),a.style.display="none",console.log("Download complete!")}catch(e){console.error("Download failed",e),i.innerText="Download failed!",setTimeout(()=>{a.style.display="none"},3e3)}}),l.dataset.listenerAttached="true")})})}},"[downloads-zip-plugin]")})();